# Makefile for ADB ARM64 Quick Compilation
# ä½¿ç”¨ NDK å·¥å…·é“¾å¿«é€Ÿç¼–è¯‘

NDK_PATH = /e/zygiské¡¹ç›®/android-ndk-r26b
CC = $(NDK_PATH)/toolchains/llvm/prebuilt/windows-x86_64/bin/aarch64-linux-android30-clang
CXX = $(NDK_PATH)/toolchains/llvm/prebuilt/windows-x86_64/bin/aarch64-linux-android30-clang++
AR = $(NDK_PATH)/toolchains/llvm/prebuilt/windows-x86_64/bin/aarch64-linux-android-ar

# ç¼–è¯‘æ ‡å¿—
CFLAGS = -O2 -Wall -D_GNU_SOURCE -DADB_HOST=0
CXXFLAGS = -O2 -Wall -std=c++17 -D_GNU_SOURCE -DADB_HOST=0 -fno-exceptions -fno-rtti
LDFLAGS = -static-libstdc++

# åŒ…å«è·¯å¾„
INCLUDES = -I. -I./daemon

# æºæ–‡ä»¶ (æœ€å°åŒ–ç‰ˆæœ¬)
CORE_SOURCES = \
    adb.cpp \
    adb_io.cpp \
    adb_utils.cpp \
    transport.cpp \
    types.cpp \
    sysdeps_unix.cpp

DAEMON_SOURCES = \
    daemon/main.cpp \
    daemon/auth.cpp \
    daemon/logging.cpp

SOURCES = $(CORE_SOURCES) $(DAEMON_SOURCES)

# ç›®æ ‡æ–‡ä»¶
OBJECTS = $(SOURCES:.cpp=.o)

# è¾“å‡ºç›®æ ‡
TARGET = adbd_arm64

# é»˜è®¤ç›®æ ‡
.PHONY: all clean help

all: $(TARGET)
	@echo ""
	@echo "âœ… ç¼–è¯‘å®Œæˆ!"
	@echo ""
	@echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶:"
	@ls -lh $(TARGET)
	@echo ""
	@file $(TARGET)
	@echo ""
	@echo "ğŸ“± æ¨é€åˆ°è®¾å¤‡:"
	@echo "  adb push $(TARGET) /system/bin/adbd"
	@echo "  adb shell chmod 755 /system/bin/adbd"
	@echo "  adb reboot"

$(TARGET): $(OBJECTS)
	@echo "ğŸ”— é“¾æ¥: $@"
	@$(CXX) $(OBJECTS) $(LDFLAGS) -o $@
	@echo "âœ“ é“¾æ¥å®Œæˆ"

%.o: %.cpp
	@echo "ğŸ“ ç¼–è¯‘: $<"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

clean:
	@echo "ğŸ—‘ï¸  æ¸…ç†..."
	@rm -f $(OBJECTS) $(TARGET)
	@echo "âœ“ æ¸…ç†å®Œæˆ"

help:
	@echo "ADB ARM64 Makefile"
	@echo ""
	@echo "å‘½ä»¤:"
	@echo "  make       - ç¼–è¯‘ adbd"
	@echo "  make clean - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make help  - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "ç¼–è¯‘æ—¶é—´: ~2-3 åˆ†é’Ÿ"
	@echo "è¾“å‡ºæ–‡ä»¶: $(TARGET)"

.PHONY: print-info
print-info:
	@echo "ç¼–è¯‘é…ç½®:"
	@echo "  NDK: $(NDK_PATH)"
	@echo "  CC: $(CC)"
	@echo "  CXX: $(CXX)"
	@echo "  CXXFLAGS: $(CXXFLAGS)"
	@echo ""
	@echo "æºæ–‡ä»¶æ•°: $(words $(SOURCES))"
	@echo "ç›®æ ‡æ–‡ä»¶: $(TARGET)"
