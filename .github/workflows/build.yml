name: Build ADB ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
    - name: Checkout modified ADB source
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          openjdk-11-jdk python3-dev \
          git curl repo \
          build-essential libssl-dev bc bison flex ccache

    - name: Configure git
      run: |
        git config --global user.email "build@example.com"
        git config --global user.name "Builder"
        git config --global gc.autodetach false
        git config --global url."https://android.googlesource.com/".insteadOf "ssh://android.googlesource.com/"

    - name: Initialize AOSP
      run: |
        mkdir -p ~/aosp
        cd ~/aosp
        echo "Initializing AOSP..."
        repo init -u https://android.googlesource.com/platform/manifest \
                  -b android-13.0.0_r1 --depth=1 2>&1 | tail -20

    - name: Sync AOSP (attempt 1/2)
      continue-on-error: true
      run: |
        cd ~/aosp
        echo "Syncing AOSP sources (attempt 1)..."
        timeout 5400 repo sync -j4 --no-tags --no-clone-bundle 2>&1 | tail -50

        # Mark success
        touch /tmp/sync_attempt1

    - name: Sync AOSP (attempt 2/2)
      if: ${{ !success() }}
      run: |
        if [ ! -f /tmp/sync_attempt1 ]; then
          cd ~/aosp
          echo "Syncing AOSP sources (attempt 2)..."
          timeout 5400 repo sync -j4 --no-tags --no-clone-bundle 2>&1 | tail -50
        fi

    - name: Verify AOSP structure
      run: |
        cd ~/aosp
        echo "Verifying AOSP files..."
        [ -f "build/envsetup.sh" ] && echo "✓ build/envsetup.sh" || exit 1
        [ -d "packages/modules/adb" ] && echo "✓ packages/modules/adb" || exit 1
        [ -d "system/core" ] && echo "✓ system/core" || exit 1

    - name: Copy modified ADB
      run: |
        cd ~/aosp
        rm -rf packages/modules/adb
        cp -r $GITHUB_WORKSPACE packages/modules/adb
        echo "✓ Modified ADB copied"

    - name: Build ADB
      run: |
        cd ~/aosp
        echo "Building ADB daemon..."
        bash -c '
          set -e
          source build/envsetup.sh > /dev/null 2>&1
          lunch aosp_arm64-eng > /dev/null 2>&1
          m adbd -j$(nproc) 2>&1 | tail -200
        '

    - name: Extract binary
      run: |
        cd ~/aosp
        echo "Locating binary..."
        ADBD_PATH=$(find out -name "adbd" -type f 2>/dev/null | head -1)
        [ -n "$ADBD_PATH" ] || (echo "❌ adbd not found"; exit 1)
        echo "✓ Found: $ADBD_PATH"
        cp "$ADBD_PATH" $GITHUB_WORKSPACE/adbd_arm64
        file $GITHUB_WORKSPACE/adbd_arm64
        ls -lh $GITHUB_WORKSPACE/adbd_arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: adbd-arm64
        path: adbd_arm64

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: adbd_arm64
        tag_name: v${{ github.run_number }}
        body: |
          # ADB ARM64 Build #${{ github.run_number }}

          **Modifications:**
          - ✓ Auth disabled (auth_required = false)
          - ✓ Always root (should_drop_privileges() = false)
          - ✓ No system properties dependency

          **Deploy:**
          ```bash
          adb push adbd_arm64 /system/bin/adbd
          adb shell chmod 755 /system/bin/adbd
          adb reboot
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
