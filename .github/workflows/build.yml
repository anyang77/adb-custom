name: Build ADB ARM64

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours total

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          openjdk-11-jdk \
          python3 python3-dev \
          git curl wget \
          repo \
          build-essential \
          libssl-dev \
          bc bison flex \
          ccache \
          ninja-build

    - name: Create AOSP workspace
      run: |
        mkdir -p ~/aosp
        cd ~/aosp
        git config --global user.email "build@example.com"
        git config --global user.name "Build System"
        git config --global gc.autodetach false

    - name: Initialize AOSP Repository
      run: |
        cd ~/aosp
        echo "=== Initializing AOSP ==="

        # Force HTTPS instead of SSH
        git config --global url."https://android.googlesource.com/".insteadOf "ssh://android.googlesource.com/"

        # Try Android 13
        echo "Attempting Android 13.0.0_r1..."
        repo init -u https://android.googlesource.com/platform/manifest \
                  -b android-13.0.0_r1 --depth=1 --no-tags 2>&1 | tail -30 && \
        echo "✓ Android 13 init successful" || {
          echo "Android 13 failed, trying Android 12..."
          repo init -u https://android.googlesource.com/platform/manifest \
                    -b android-12.0.0_r1 --depth=1 --no-tags 2>&1 | tail -30 && \
          echo "✓ Android 12 init successful" || {
            echo "❌ Both Android 13 and 12 failed"
            exit 1
          }
        }

    - name: Sync AOSP Sources
      run: |
        cd ~/aosp
        echo "=== Syncing AOSP Sources (this takes 1-2 hours) ==="

        # Sync with very long timeout - use different flags that are more reliable
        timeout 7200 repo sync -j4 --no-tags --no-clone-bundle \
          packages/modules/adb \
          build/make \
          system/core \
          system/libbase \
          system/logging \
          system/memory/libmemunreachable \
          system/unwinding \
          external/libcxx \
          external/libcxxabi \
          prebuilts/sdk \
          prebuilts/clang/host/linux-x86 \
          frameworks/native \
          bionic \
          2>&1 | tail -50

        # Check result explicitly
        SYNC_RESULT=$?
        echo ""
        echo "Sync exit code: $SYNC_RESULT"

        # Even if timeout, check if key files exist
        if [ -d "packages/modules/adb" ] && [ -f "build/make/core/main.mk" ]; then
          echo "✓ Essential AOSP files synced successfully"
        else
          echo "⚠ Some files may not be synced, continuing anyway..."
          echo "Checking directory status:"
          [ -d "packages/modules/adb" ] && echo "  ✓ packages/modules/adb exists" || echo "  ✗ packages/modules/adb MISSING"
          [ -d "build/make" ] && echo "  ✓ build/make exists" || echo "  ✗ build/make MISSING"
          [ -d "system/core" ] && echo "  ✓ system/core exists" || echo "  ✗ system/core MISSING"
        fi

    - name: Verify AOSP Structure
      run: |
        cd ~/aosp
        echo "=== Verifying AOSP Structure ==="

        [ -d "packages/modules/adb" ] && echo "✓ packages/modules/adb" || (echo "✗ Missing adb"; exit 1)
        [ -d "build/make" ] && echo "✓ build/make" || (echo "✗ Missing build/make"; exit 1)
        [ -d "system/core" ] && echo "✓ system/core" || (echo "✗ Missing system/core"; exit 1)
        [ -f "build/envsetup.sh" ] && echo "✓ build/envsetup.sh" || (echo "✗ Missing envsetup.sh"; exit 1)

    - name: Copy Modified ADB Source
      run: |
        cd ~/aosp
        echo "=== Copying Modified ADB Source ==="

        rm -rf packages/modules/adb
        cp -r $GITHUB_WORKSPACE packages/modules/adb

        echo "✓ Modified ADB copied to AOSP"
        ls -la packages/modules/adb/ | head -10

    - name: Setup Build Environment
      run: |
        cd ~/aosp
        echo "=== Setting Up Build Environment ==="

        # Check if build/envsetup.sh exists
        if [ ! -f "build/envsetup.sh" ]; then
          echo "❌ build/envsetup.sh not found!"
          echo "Checking what was synced:"
          ls -la build/ 2>/dev/null | head -20
          echo ""
          echo "AOSP root contents:"
          ls -la ~ aosp/ | head -30
          exit 1
        fi

        # Source the build environment
        source build/envsetup.sh > /dev/null 2>&1 || {
          echo "⚠ build/envsetup.sh source failed, trying with bash..."
          bash build/envsetup.sh > /dev/null 2>&1 || true
        }

        # Try to configure for ARM64
        if command -v lunch &> /dev/null; then
          lunch aosp_arm64-eng > /dev/null 2>&1 || true
          echo "✓ Build environment configured"
        else
          echo "⚠ lunch command not available, continuing anyway..."
        fi

    - name: Build ADB Daemon
      run: |
        cd ~/aosp
        echo "=== Building ADB Daemon ==="

        # Check if envsetup.sh really exists and is readable
        if [ ! -f "build/envsetup.sh" ]; then
          echo "❌ build/envsetup.sh NOT FOUND"
          ls -la build/ 2>/dev/null || echo "build/ doesn't exist"
          exit 1
        fi

        echo "✓ build/envsetup.sh found"

        # Try to source it with debug output
        echo "Attempting to source build/envsetup.sh..."
        bash -c '
          set -x  # Enable debug output
          cd ~/aosp
          source build/envsetup.sh 2>&1 | head -30
          echo "envsetup sourced"

          echo "Running lunch..."
          lunch aosp_arm64-eng 2>&1 | head -30
          echo "lunch complete"

          echo "Checking m command..."
          which m || echo "m not found"

          echo "Starting build..."
          m adbd -j4 2>&1 | tail -200
        ' 2>&1 | head -300

    - name: Locate and Verify Binary
      run: |
        cd ~/aosp
        echo "=== Locating Compiled Binary ==="

        # Find the adbd binary
        ADBD_PATH=$(find out -name "adbd" -type f 2>/dev/null | grep -v ".git" | head -1)

        if [ -z "$ADBD_PATH" ]; then
          echo "❌ adbd binary not found in out/"
          echo "Searching entire AOSP directory..."
          find . -name "adbd" -type f 2>/dev/null | head -5
          exit 1
        fi

        echo "✓ Found: $ADBD_PATH"
        file "$ADBD_PATH"
        ls -lh "$ADBD_PATH"

        # Copy to workspace root
        cp "$ADBD_PATH" $GITHUB_WORKSPACE/adbd_arm64
        echo "✓ Binary copied to workspace"

    - name: Verify Final Binary
      run: |
        cd $GITHUB_WORKSPACE
        echo "=== Verifying Final Binary ==="

        if [ ! -f "adbd_arm64" ]; then
          echo "❌ Final binary not found"
          exit 1
        fi

        file adbd_arm64
        ls -lh adbd_arm64
        echo "✓ Binary ready for release"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: adbd-arm64
        path: adbd_arm64
        retention-days: 30

    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: adbd_arm64
        tag_name: v${{ github.run_number }}
        body: |
          # ADB ARM64 Build #${{ github.run_number }}

          **修改说明:**
          - ✓ 禁用授权检查 (auth_required = false)
          - ✓ 强制 Root 权限 (should_drop_privileges() = false)
          - ✓ 无系统属性依赖

          **使用方法:**
          ```bash
          adb push adbd_arm64 /system/bin/adbd
          adb shell chmod 755 /system/bin/adbd
          adb reboot
          ```

          **编译信息:**
          - 架构: ARM64 (aarch64)
          - API 级别: 30+
          - 使用方法：完整 AOSP 编译
          - 编译 ID: ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
