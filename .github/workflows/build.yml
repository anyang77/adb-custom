name: Build ADB ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download AOSP cache
      run: |
        echo "=== Downloading AOSP cache from releases ==="
        mkdir -p ~/aosp
        cd ~/aosp

        # Try to download cached AOSP
        RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/aosp-cache"
        if curl -s -I "$RELEASE_URL" | grep -q "200 OK"; then
          echo "✓ Found AOSP cache release"
          wget -q --show-progress https://github.com/${{ github.repository }}/releases/download/aosp-cache/aosp-android13.tar.gz
          tar -xzf aosp-android13.tar.gz
          rm aosp-android13.tar.gz
          echo "✓ AOSP cache extracted"
        else
          echo "❌ AOSP cache not found in releases"
          echo "Please upload AOSP cache first:"
          echo "  1. Run locally: bash build_and_upload_cache.sh"
          echo "  2. Then push: git push origin main"
          exit 1
        fi

    - name: Copy modified ADB
      run: |
        cd ~/aosp
        rm -rf packages/modules/adb
        cp -r $GITHUB_WORKSPACE packages/modules/adb
        echo "✓ Modified ADB copied"

    - name: Setup git
      run: |
        git config --global user.email "build@example.com"
        git config --global user.name "Builder"

    - name: Compile ADB
      run: |
        cd ~/aosp
        echo "=== Building ADB ==="
        bash -c '
          set -e
          source build/envsetup.sh > /dev/null 2>&1
          lunch aosp_arm64-eng > /dev/null 2>&1
          m adbd -j$(nproc) 2>&1 | tail -50
        '
        echo "✓ Build completed"

    - name: Extract binary
      run: |
        cd ~/aosp
        ADBD_PATH=$(find out -name "adbd" -type f 2>/dev/null | head -1)
        [ -n "$ADBD_PATH" ] || (echo "❌ adbd not found"; exit 1)
        cp "$ADBD_PATH" $GITHUB_WORKSPACE/adbd_arm64
        echo "✓ Binary extracted"
        ls -lh $GITHUB_WORKSPACE/adbd_arm64

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: adbd-arm64
        path: adbd_arm64

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        files: adbd_arm64
        tag_name: v${{ github.run_number }}
        body: |
          # ADB ARM64 Build #${{ github.run_number }}

          **Deploy to device:**
          ```bash
          adb push adbd_arm64 /system/bin/adbd
          adb shell chmod 755 /system/bin/adbd
          adb reboot
          ```

          **Architecture:** ARM64 (aarch64)
          **API Level:** 30+
          **Build ID:** ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
